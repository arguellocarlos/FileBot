{ source,target,metadata -> if (type.toString() != "Episode" || !vf || ext =~ /(ass|srt|ssa|vtt)/) {return null};def Rb = target.dir;def Joo = any{ s } { 0 };def Hu = any{ e } { special };def rcG = 0;def nq = null;try {if (db.TheTVDB?.id) {def KU = "https://api.tvmaze.com";def Dd = curl "$KU/lookup/shows?thetvdb=${db.TheTVDB.id}";def kR = Dd.id;nq = curl "$KU/shows/$kR/episodebynumber?season=$Joo&number=$Hu";rcG = nq.id}} catch (Exception err) {};def U_N = "";def NZu = "en-US";def Qz = null;def leo = new File("$home/.filebotsecrets.json");if (leo.exists()) {def xCS = new groovy.json.JsonSlurper().parseText(leo.text);U_N = xCS.U_N;NZu = xCS.language;Qz = xCS.person_info_dir};def QpZ = "https://api.themoviedb.org/3/tv/$id/season/$Joo/episode/$Hu";def ZV = ["accept":"application/json"];def VLC = curl(ZV,"$QpZ?language=$NZu&api_key=$U_N");def _i = curl(ZV,"$QpZ/external_ids?api_key=$U_N");def fRx = curl(ZV,"$QpZ/credits?language=$NZu&api_key=$U_N");def AVs = curl(ZV,"$QpZ/images?include_image_language=en%2Cnull&api_key=$U_N");def ve = (Rb / target.nameWithoutExtension + "-thumb.jpg").toString();def vKM = new File(ve);def zU = new File(ve.replace("-thumb",""));if (!(vKM.exists() || zU.exists()) && AVs.stills.size() > 0) {def oBj = "https://image.tmdb.org/t/p/original${AVs.stills[0].file_path}";system "curl","-o",Rb / target.nameWithoutExtension + "-thumb.jpg",oBj};def yr = [];(fRx.cast + fRx.guest_stars).eachWithIndex { Bf,IL -> def UnS = "$Qz/${Bf.name[0]}/${Bf.name}";def qwH = Bf.order ?:IL + yr.size();yr << [Sh:Bf.name,rz:Bf.character,iQ:qwH,UnS:"${UnS}/folder.jpg"];if (Qz) {def yyJ = new File(UnS);if (!yyJ.exists()) {yyJ.mkdirs();system "curl","-o","${UnS}/folder.jpg","https://image.tmdb.org/t/p/original${Bf.profile_path}"}}};def wmU = Rb / target.nameWithoutExtension + ".nfo";XML(wmU) {mkp.xmlDeclaration(version:"1.0",encoding:"utf-8",standalone:"yes");episodedetails {plot(VLC.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss",TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type:"tmdb",value:episode.id,'default':"true",episode.id);tmdbid(episode.id);if (_i?.imdb_id) {uniqueid(type:"imdb",value:_i.imdb_id,_i.imdb_id);imdbid(_i.imdb_id)};if (_i?.tvdb_id) {uniqueid(type:"tvdb",value:_i.tvdb_id,_i.tvdb_id);tvdbid(_i.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type:"anidb",value:db.AniDB.episode.id,db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (rcG) {uniqueid(type:"tvmaze",value:rcG,rcG);tvmazeid(rcG)}} catch (Exception err) {};if (vKM.exists()) {art {poster(ve)}};yr.each { Sn ->  actor {name(Sn.Sh);role(Sn.rz);sortorder(Sn.iQ);if (Qz) { thumb(Sn.UnS) }}};showtitle(n);episode(Hu);season(Joo);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { ABI ->  video {def Oa_ = Float.parseFloat(ABI.'Duration');codec(ABI.'Format');micodec(ABI.'Format');bitrate(ABI.'BitRate');width(ABI.'Width');height(ABI.'Height');aspect(ABI.'DisplayAspectRatio/String');aspectratio(ABI.'DisplayAspectRatio/String');framerate(ABI.'FrameRate');'default'(ABI.'Default' == "Yes" ? "True" : "False");forced(ABI.'Forced' == "Yes" ? "True" : "False");duration(ABI.'Duration' ? (int) Math.floor(Oa_ / 60000) : 0);durationinseconds(ABI.'Duration' ? (int) Math.floor(Oa_ / 1000) : 0)}};target.mediaInfo.Audio.each { dD ->  audio {codec(dD.'Format');micodec(dD.'Format');language(dD.'Language/String3');channels(dD.'Channel(s)');samplingrate(dD.'SamplingRate');'default'(dD.'Default' == "Yes" ? "True" : "False");forced(dD.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { lNX ->  subtitle {codec(lNX.'Format');micodec(lNX.'Format');width('0');height('0');language(lNX.'Language/String3');'default'(lNX.'Default' == "Yes" ? "True" : "False");forced(lNX.'Forced' == "Yes" ? "True" : "False")}}}}}}}