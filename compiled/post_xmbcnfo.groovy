{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def LBA = target.dir;def VA = any{ s } { 0 };def bGZ = any{ e } { special };def ds = 0;def Wg = null;try {if (db.TheTVDB?.id) {def BP_ = "https://api.tvmaze.com";def Dx = curl "$BP_/lookup/shows?thetvdb=${db.TheTVDB.id}";def ami = Dx.id;Wg = curl "$BP_/shows/$ami/episodebynumber?season=$VA&number=$bGZ";ds = Wg.id}} catch (Exception err) {};def _N = "";def ExG = "en-US";def yU = null;def oDA = new File("$home/.filebotsecrets.json");if (oDA.exists()) {def zur = new groovy.json.JsonSlurper().parseText(oDA.text);_N = zur._N;ExG = zur.language;yU = zur.person_info_dir};def juQ = "https://api.themoviedb.org/3/tv/$id/season/$VA/episode/$bGZ";def Oe = ["accept": "application/json"];def xwv = curl(Oe, "$juQ?language=$ExG&api_key=$_N");def Pt = curl(Oe, "$juQ/external_ids?api_key=$_N");def Kim = curl(Oe, "$juQ/credits?language=$ExG&api_key=$_N");def WTA = curl(Oe, "$juQ/images?include_image_language=en%2Cnull&api_key=$_N");def nP = (LBA / target.nameWithoutExtension + "-thumb.jpg").toString();def ETr = new File(nP);def wp = new File(nP.replace("-thumb",""));if (!(ETr.exists() || wp.exists()) && WTA.stills.size() > 0) {def cs = "https://image.tmdb.org/t/p/original${WTA.stills[0].file_path}";system "curl", "-o", LBA / target.nameWithoutExtension + "-thumb.jpg", cs};def Yll = [];(Kim.cast + Kim.guest_stars).eachWithIndex { ilG, eDk ->  def Zn = "$yU/${ilG.name[0]}/${ilG.name}";def Pfa = ilG.order ?: eDk + Yll.size();Yll << [nOq: ilG.name, Wh: ilG.character, Hj: Pfa, Zn: "${Zn}/folder.jpg"];if (yU) {def yK = new File(Zn);if (!yK.exists()) {yK.mkdirs();system "curl", "-o", "${Zn}/folder.jpg", "https://image.tmdb.org/t/p/original${ilG.profile_path}"}}};def zsY = LBA / target.nameWithoutExtension + ".nfo";XML(zsY) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(xwv.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (Pt?.imdb_id) {uniqueid(type: "imdb", value: Pt.imdb_id, Pt.imdb_id);imdbid(Pt.imdb_id)};if (Pt?.tvdb_id) {uniqueid(type: "tvdb", value: Pt.tvdb_id, Pt.tvdb_id);tvdbid(Pt.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (ds) {uniqueid(type: "tvmaze", value: ds, ds);tvmazeid(ds)}} catch (Exception err) {};if (ETr.exists()) {art {poster(nP)}};Yll.each { _la ->  actor {name(_la.nOq);role(_la.Wh);sortorder(_la.Hj);if (yU) { thumb(_la.Zn) }}};showtitle(n);episode(bGZ);season(VA);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { YiF ->  video {def bjG = Float.parseFloat(YiF.'Duration');codec(YiF.'Format');micodec(YiF.'Format');bitrate(YiF.'BitRate');width(YiF.'Width');height(YiF.'Height');aspect(YiF.'DisplayAspectRatio/String');aspectratio(YiF.'DisplayAspectRatio/String');framerate(YiF.'FrameRate');'default'(YiF.'Default' == "Yes" ? "True" : "False");forced(YiF.'Forced' == "Yes" ? "True" : "False");duration(YiF.'Duration' ? (int) Math.floor(bjG / 60000) : 0);durationinseconds(YiF.'Duration' ? (int) Math.floor(bjG / 1000) : 0)}};target.mediaInfo.Audio.each { sV ->  audio {codec(sV.'Format');micodec(sV.'Format');language(sV.'Language/String3');channels(sV.'Channel(s)');samplingrate(sV.'SamplingRate');'default'(sV.'Default' == "Yes" ? "True" : "False");forced(sV.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { nf ->  subtitle {codec(nf.'Format');micodec(nf.'Format');width('0');height('0');language(nf.'Language/String3');'default'(nf.'Default' == "Yes" ? "True" : "False");forced(nf.'Forced' == "Yes" ? "True" : "False")}}}}}}}