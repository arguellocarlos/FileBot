{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def Eei = target.dir;def Mq = any{ s } { 0 };def EP = any{ e } { special };def lk = 0;def Ng = null;try {if (db.TheTVDB?.id) {def Rg = "https://api.tvmaze.com";def NI = curl "$Rg/lookup/shows?thetvdb=${db.TheTVDB.id}";def jg = NI.id;Ng = curl "$Rg/shows/$jg/episodebynumber?season=$Mq&number=$EP";lk = Ng.id}} catch (Exception err) {};def hqi = "";def vK = "en-US";def Pny = null;def ZX = new File("$home/.filebotsecrets.json");if (ZX.exists()) {def Dsw = new groovy.json.JsonSlurper().parseText(ZX.text);hqi = Dsw.hqi;vK = Dsw.language;Pny = Dsw.person_info_dir};def yu = "https://api.themoviedb.org/3/tv/$id/season/$Mq/episode/$EP";def ad = ["accept": "application/json"];def Nl = curl(ad, "$yu?language=$vK&api_key=$hqi");def Wm = curl(ad, "$yu/external_ids?api_key=$hqi");def tU = curl(ad, "$yu/credits?language=$vK&api_key=$hqi");def GLp = curl(ad, "$yu/images?include_image_language=en%2Cnull&api_key=$hqi");def fo = (Eei / target.nameWithoutExtension + "-thumb.jpg").toString();def Nd = new File(fo);def pL = new File(fo.replace("-thumb",""));if (!(Nd.exists() || pL.exists()) && GLp.stills.size() > 0) {def Sr = "https://image.tmdb.org/t/p/original${GLp.stills[0].file_path}";system "curl", "-o", Eei / target.nameWithoutExtension + "-thumb.jpg", Sr};def Zb = [];(tU.cast + tU.guest_stars).eachWithIndex { MGu, NPJ ->  def iNn = "$Pny/${MGu.name[0]}/${MGu.name}";def zg = MGu.order ?: NPJ + Zb.size();Zb << [eIQ: MGu.name, xK: MGu.character, RQA: zg, iNn: "${iNn}/folder.jpg"];if (Pny) {def lL = new File(iNn);if (!lL.exists()) {lL.mkdirs();system "curl", "-o", "${iNn}/folder.jpg", "https://image.tmdb.org/t/p/original${MGu.profile_path}"}}};def xQE = Eei / target.nameWithoutExtension + ".nfo";XML(xQE) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(Nl.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (Wm?.imdb_id) {uniqueid(type: "imdb", value: Wm.imdb_id, Wm.imdb_id);imdbid(Wm.imdb_id)};if (Wm?.tvdb_id) {uniqueid(type: "tvdb", value: Wm.tvdb_id, Wm.tvdb_id);tvdbid(Wm.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (lk) {uniqueid(type: "tvmaze", value: lk, lk);tvmazeid(lk)}} catch (Exception err) {};if (Nd.exists()) {art {poster(fo)}};Zb.each { RN ->  actor {name(RN.eIQ);role(RN.xK);sortorder(RN.RQA);if (Pny) { thumb(RN.iNn) }}};showtitle(n);episode(EP);season(Mq);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { iQ ->  video {def ZZ = Float.parseFloat(iQ.'Duration');codec(iQ.'Format');micodec(iQ.'Format');bitrate(iQ.'BitRate');width(iQ.'Width');height(iQ.'Height');aspect(iQ.'DisplayAspectRatio/String');aspectratio(iQ.'DisplayAspectRatio/String');framerate(iQ.'FrameRate');'default'(iQ.'Default' == "Yes" ? "True" : "False");forced(iQ.'Forced' == "Yes" ? "True" : "False");duration(iQ.'Duration' ? (int) Math.floor(ZZ / 60000) : 0);durationinseconds(iQ.'Duration' ? (int) Math.floor(ZZ / 1000) : 0)}};target.mediaInfo.Audio.each { yx ->  audio {codec(yx.'Format');micodec(yx.'Format');language(yx.'Language/String3');channels(yx.'Channel(s)');samplingrate(yx.'SamplingRate');'default'(yx.'Default' == "Yes" ? "True" : "False");forced(yx.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { Kud ->  subtitle {codec(Kud.'Format');micodec(Kud.'Format');width('0');height('0');language(Kud.'Language/String3');'default'(Kud.'Default' == "Yes" ? "True" : "False");forced(Kud.'Forced' == "Yes" ? "True" : "False")}}}}}}}