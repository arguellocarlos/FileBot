{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def hQZ = target.dir;def VON = any{ s } { 0 };def vQk = any{ e } { special };def XyN = 0;def ML = null;try {if (db.TheTVDB?.id) {def UM = "https://api.tvmaze.com";def dpC = curl "$UM/lookup/shows?thetvdb=${db.TheTVDB.id}";def _Wo = dpC.id;ML = curl "$UM/shows/$_Wo/episodebynumber?season=$VON&number=$vQk";XyN = ML.id}} catch (Exception err) {};def BWH = "";def tA = "en-US";def vD = null;def On = new File("$home/.filebotsecrets.json");if (On.exists()) {def kh = new groovy.json.JsonSlurper().parseText(On.text);BWH = kh.BWH;tA = kh.language;vD = kh.person_info_dir};def veY = "https://api.themoviedb.org/3/tv/$id/season/$VON/episode/$vQk";def Luu = ["accept": "application/json"];def QN = curl(Luu, "$veY?language=$tA&api_key=$BWH");def oz = curl(Luu, "$veY/external_ids?api_key=$BWH");def dw = curl(Luu, "$veY/credits?language=$tA&api_key=$BWH");def Ykc = curl(Luu, "$veY/images?include_image_language=en%2Cnull&api_key=$BWH");def QKw = (hQZ / target.nameWithoutExtension + "-thumb.jpg").toString();def MQ = new File(QKw);def Ug = new File(QKw.replace("-thumb",""));if (!(MQ.exists() || Ug.exists()) && Ykc.stills.size() > 0) {def ww = "https://image.tmdb.org/t/p/original${Ykc.stills[0].file_path}";system "curl", "-o", hQZ / target.nameWithoutExtension + "-thumb.jpg", ww};def qaL = [];(dw.cast + dw.guest_stars).eachWithIndex { AET, Obw ->  def SF = "$vD/${AET.name[0]}/${AET.name}";def cub = AET.order ?: Obw + qaL.size();qaL << [DSy: AET.name, ZGQ: AET.character, pfu: cub, SF: "${SF}/folder.jpg"];if (vD) {def zr = new File(SF);if (!zr.exists()) {zr.mkdirs();system "curl", "-o", "${SF}/folder.jpg", "https://image.tmdb.org/t/p/original${AET.profile_path}"}}};def Rq = hQZ / target.nameWithoutExtension + ".nfo";XML(Rq) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(QN.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (oz?.imdb_id) {uniqueid(type: "imdb", value: oz.imdb_id, oz.imdb_id);imdbid(oz.imdb_id)};if (oz?.tvdb_id) {uniqueid(type: "tvdb", value: oz.tvdb_id, oz.tvdb_id);tvdbid(oz.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (XyN) {uniqueid(type: "tvmaze", value: XyN, XyN);tvmazeid(XyN)}} catch (Exception err) {};if (MQ.exists()) {art {poster(QKw)}};qaL.each { Ase ->  actor {name(Ase.DSy);role(Ase.ZGQ);sortorder(Ase.pfu);if (vD) { thumb(Ase.SF) }}};showtitle(n);episode(vQk);season(VON);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { vfK ->  video {def uS = Float.parseFloat(vfK.'Duration');codec(vfK.'Format');micodec(vfK.'Format');bitrate(vfK.'BitRate');width(vfK.'Width');height(vfK.'Height');aspect(vfK.'DisplayAspectRatio/String');aspectratio(vfK.'DisplayAspectRatio/String');framerate(vfK.'FrameRate');'default'(vfK.'Default' == "Yes" ? "True" : "False");forced(vfK.'Forced' == "Yes" ? "True" : "False");duration(vfK.'Duration' ? (int) Math.floor(uS / 60000) : 0);durationinseconds(vfK.'Duration' ? (int) Math.floor(uS / 1000) : 0)}};target.mediaInfo.Audio.each { gRB ->  audio {codec(gRB.'Format');micodec(gRB.'Format');language(gRB.'Language/String3');channels(gRB.'Channel(s)');samplingrate(gRB.'SamplingRate');'default'(gRB.'Default' == "Yes" ? "True" : "False");forced(gRB.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { fSg ->  subtitle {codec(fSg.'Format');micodec(fSg.'Format');width('0');height('0');language(fSg.'Language/String3');'default'(fSg.'Default' == "Yes" ? "True" : "False");forced(fSg.'Forced' == "Yes" ? "True" : "False")}}}}}}}