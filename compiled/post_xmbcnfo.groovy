{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def Wo = target.dir;def Gm = any{ s } { 0 };def MK = any{ e } { special };def Jh_ = 0;def PL = null;try {if (db.TheTVDB?.id) {def Kt = "https://api.tvmaze.com";def dlx = curl "$Kt/lookup/shows?thetvdb=${db.TheTVDB.id}";def dM = dlx.id;PL = curl "$Kt/shows/$dM/episodebynumber?season=$Gm&number=$MK";Jh_ = PL.id}} catch (Exception err) {};def fLk = "";def Cv = "en-US";def IE = null;def wjs = new File("$home/.filebotsecrets.json");if (wjs.exists()) {def bt = new groovy.json.JsonSlurper().parseText(wjs.text);fLk = bt.fLk;Cv = bt.language;IE = bt.person_info_dir};def iWQ = "https://api.themoviedb.org/3/tv/$id/season/$Gm/episode/$MK";def MQ = ["accept": "application/json"];def ZpI = curl(MQ, "$iWQ?language=$Cv&api_key=$fLk");def Hl = curl(MQ, "$iWQ/external_ids?api_key=$fLk");def Da = curl(MQ, "$iWQ/credits?language=$Cv&api_key=$fLk");def NF = curl(MQ, "$iWQ/images?include_image_language=en%2Cnull&api_key=$fLk");def qd = (Wo / target.nameWithoutExtension + "-thumb.jpg").toString();def KT = new File(qd);def zB = new File(qd.replace("-thumb",""));if (!(KT.exists() || zB.exists()) && NF.stills.size() > 0) {def mkS = "https://image.tmdb.org/t/p/original${NF.stills[0].file_path}";system "curl", "-o", Wo / target.nameWithoutExtension + "-thumb.jpg", mkS};def czp = [];(Da.cast + Da.guest_stars).eachWithIndex { tRb, XV ->  def Eq = "$IE/${tRb.name[0]}/${tRb.name}";def aWu = tRb.order ?: XV + czp.size();czp << [gG: tRb.name, Vm: tRb.character, JR: aWu, Eq: "${Eq}/folder.jpg"];if (IE) {def G_r = new File(Eq);if (!G_r.exists()) {G_r.mkdirs();system "curl", "-o", "${Eq}/folder.jpg", "https://image.tmdb.org/t/p/original${tRb.profile_path}"}}};def BLE = Wo / target.nameWithoutExtension + ".nfo";XML(BLE) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(ZpI.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (Hl?.imdb_id) {uniqueid(type: "imdb", value: Hl.imdb_id, Hl.imdb_id);imdbid(Hl.imdb_id)};if (Hl?.tvdb_id) {uniqueid(type: "tvdb", value: Hl.tvdb_id, Hl.tvdb_id);tvdbid(Hl.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (Jh_) {uniqueid(type: "tvmaze", value: Jh_, Jh_);tvmazeid(Jh_)}} catch (Exception err) {};if (KT.exists()) {art {poster(qd)}};czp.each { lj ->  actor {name(lj.gG);role(lj.Vm);sortorder(lj.JR);if (IE) { thumb(lj.Eq) }}};showtitle(n);episode(MK);season(Gm);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { Bgm ->  video {def ijD = Float.parseFloat(Bgm.'Duration');codec(Bgm.'Format');micodec(Bgm.'Format');bitrate(Bgm.'BitRate');width(Bgm.'Width');height(Bgm.'Height');aspect(Bgm.'DisplayAspectRatio/String');aspectratio(Bgm.'DisplayAspectRatio/String');framerate(Bgm.'FrameRate');'default'(Bgm.'Default' == "Yes" ? "True" : "False");forced(Bgm.'Forced' == "Yes" ? "True" : "False");duration(Bgm.'Duration' ? (int) Math.floor(ijD / 60000) : 0);durationinseconds(Bgm.'Duration' ? (int) Math.floor(ijD / 1000) : 0)}};target.mediaInfo.Audio.each { NL ->  audio {codec(NL.'Format');micodec(NL.'Format');language(NL.'Language/String3');channels(NL.'Channel(s)');samplingrate(NL.'SamplingRate');'default'(NL.'Default' == "Yes" ? "True" : "False");forced(NL.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { pf ->  subtitle {codec(pf.'Format');micodec(pf.'Format');width('0');height('0');language(pf.'Language/String3');'default'(pf.'Default' == "Yes" ? "True" : "False");forced(pf.'Forced' == "Yes" ? "True" : "False")}}}}}}}