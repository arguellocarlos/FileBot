{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def Uj = target.dir;def XAV = any{ s } { 0 };def jyj = any{ e } { special };def TkL = 0;def sIw = null;try {if (db.TheTVDB?.id) {def Sl = "https://api.tvmaze.com";def f_t = curl "$Sl/lookup/shows?thetvdb=${db.TheTVDB.id}";def ky = f_t.id;sIw = curl "$Sl/shows/$ky/episodebynumber?season=$XAV&number=$jyj";TkL = sIw.id}} catch (Exception err) {};def bV = "";def Qhr = "en-US";def yn = null;def tuG = new File("$home/.filebotsecrets.json");if (tuG.exists()) {def Sj = new groovy.json.JsonSlurper().parseText(tuG.text);bV = Sj.bV;Qhr = Sj.language;yn = Sj.person_info_dir};def ap = "https://api.themoviedb.org/3/tv/$id/season/$XAV/episode/$jyj";def NI = ["accept": "application/json"];def wb = curl(NI, "$ap?language=$Qhr&api_key=$bV");def qV = curl(NI, "$ap/external_ids?api_key=$bV");def FE = curl(NI, "$ap/credits?language=$Qhr&api_key=$bV");def iLl = curl(NI, "$ap/images?include_image_language=en%2Cnull&api_key=$bV");def Ro = (Uj / target.nameWithoutExtension + "-thumb.jpg").toString();def euK = new File(Ro);def MLg = new File(Ro.replace("-thumb",""));if (!(euK.exists() || MLg.exists()) && iLl.stills.size() > 0) {def LZ = "https://image.tmdb.org/t/p/original${iLl.stills[0].file_path}";system "curl", "-o", Uj / target.nameWithoutExtension + "-thumb.jpg", LZ};def dv = [];(FE.cast + FE.guest_stars).eachWithIndex { FZz, Oap ->  def vE = "$yn/${FZz.name[0]}/${FZz.name}";def qjo = FZz.order ?: Oap + dv.size();dv << [yKN: FZz.name, gd: FZz.character, RXy: qjo, vE: "${vE}/folder.jpg"];if (yn) {def xNU = new File(vE);if (!xNU.exists()) {xNU.mkdirs();system "curl", "-o", "${vE}/folder.jpg", "https://image.tmdb.org/t/p/original${FZz.profile_path}"}}};def dj = Uj / target.nameWithoutExtension + ".nfo";XML(dj) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(wb.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (qV?.imdb_id) {uniqueid(type: "imdb", value: qV.imdb_id, qV.imdb_id);imdbid(qV.imdb_id)};if (qV?.tvdb_id) {uniqueid(type: "tvdb", value: qV.tvdb_id, qV.tvdb_id);tvdbid(qV.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (TkL) {uniqueid(type: "tvmaze", value: TkL, TkL);tvmazeid(TkL)}} catch (Exception err) {};if (euK.exists()) {art {poster(Ro)}};dv.each { vHy ->  actor {name(vHy.yKN);role(vHy.gd);sortorder(vHy.RXy);if (yn) { thumb(vHy.vE) }}};showtitle(n);episode(jyj);season(XAV);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { kUo ->  video {def uD = Float.parseFloat(kUo.'Duration');codec(kUo.'Format');micodec(kUo.'Format');bitrate(kUo.'BitRate');width(kUo.'Width');height(kUo.'Height');aspect(kUo.'DisplayAspectRatio/String');aspectratio(kUo.'DisplayAspectRatio/String');framerate(kUo.'FrameRate');'default'(kUo.'Default' == "Yes" ? "True" : "False");forced(kUo.'Forced' == "Yes" ? "True" : "False");duration(kUo.'Duration' ? (int) Math.floor(uD / 60000) : 0);durationinseconds(kUo.'Duration' ? (int) Math.floor(uD / 1000) : 0)}};target.mediaInfo.Audio.each { Xo ->  audio {codec(Xo.'Format');micodec(Xo.'Format');language(Xo.'Language/String3');channels(Xo.'Channel(s)');samplingrate(Xo.'SamplingRate');'default'(Xo.'Default' == "Yes" ? "True" : "False");forced(Xo.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { rin ->  subtitle {codec(rin.'Format');micodec(rin.'Format');width('0');height('0');language(rin.'Language/String3');'default'(rin.'Default' == "Yes" ? "True" : "False");forced(rin.'Forced' == "Yes" ? "True" : "False")}}}}}}}