{ source, target, metadata -> if (type.toString() != "Episode" && !f.video) {return null};def wbf = target.dir;def ZTX = any{ s } { 0 };def Gx = any{ e } { special };def Mhh = 0;def I_a = null;try {if (db.TheTVDB?.id) {def IF = "https://api.tvmaze.com";def Zwi = curl "$IF/lookup/shows?thetvdb=${db.TheTVDB.id}";def Bv = Zwi.id;I_a = curl "$IF/shows/$Bv/episodebynumber?season=$ZTX&number=$Gx";Mhh = I_a.id}} catch (Exception err) {};def kA = "";def eX = "en-US";def YNY = null;def YpQ = new File("$home/.filebotsecrets.json");if (YpQ.exists()) {def TOR = new groovy.json.JsonSlurper().parseText(YpQ.text);kA = TOR.kA;eX = TOR.language;YNY = TOR.person_info_dir};def qbS = "https://api.themoviedb.org/3/tv/$id/season/$ZTX/episode/$Gx";def NqU = ["accept": "application/json"];def Ud = curl(NqU, "$qbS?language=$eX&api_key=$kA");def rgT = curl(NqU, "$qbS/external_ids?api_key=$kA");def oA = curl(NqU, "$qbS/credits?language=$eX&api_key=$kA");def lN = curl(NqU, "$qbS/images?include_image_language=en%2Cnull&api_key=$kA");def WNz = (wbf / target.nameWithoutExtension + "-thumb.jpg").toString();def lyh = new File(WNz);def eGX = new File(WNz.replace("-thumb",""));if (!(lyh.exists() || eGX.exists()) && lN.stills.size() > 0) {def XCJ = "https://image.tmdb.org/t/p/original${lN.stills[0].file_path}";system "curl", "-o", wbf / target.nameWithoutExtension + "-thumb.jpg", XCJ};def xRT = [];(oA.cast + oA.guest_stars).eachWithIndex { qhp, ui -> def Xzi = "$YNY/${qhp.name[0]}/${qhp.name}";def OS = qhp.order ?: ui + xRT.size();xRT << [Z_: qhp.name, Ta: qhp.character, DUi: OS, Xzi: "${Xzi}/folder.jpg"];if (YNY) {def EQ = new File(Xzi);if (!EQ.exists()) {EQ.mkdirs();system "curl", "-o", "${Xzi}/folder.jpg", "https://image.tmdb.org/t/p/original${qhp.profile_path}"}}};def Xac = wbf / target.nameWithoutExtension + ".nfo";XML(Xac) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(Ud.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (rgT?.imdb_id) {uniqueid(type: "imdb", value: rgT.imdb_id, rgT.imdb_id);imdbid(rgT.imdb_id)};if (rgT?.tvdb_id) {uniqueid(type: "tvdb", value: rgT.tvdb_id, rgT.tvdb_id);tvdbid(rgT.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (Mhh) {uniqueid(type: "tvmaze", value: Mhh, Mhh);tvmazeid(Mhh)}} catch (Exception err) {};if (lyh.exists()) {art {poster(WNz)}};xRT.each { INA ->  actor {name(INA.Z_);role(INA.Ta);sortorder(INA.DUi);if (YNY) { thumb(INA.Xzi) }}};showtitle(n);episode(Gx);season(ZTX);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { rfr ->  video {def vu = Float.parseFloat(rfr.'Duration');codec(rfr.'Format');micodec(rfr.'Format');bitrate(rfr.'BitRate');width(rfr.'Width');height(rfr.'Height');aspect(rfr.'DisplayAspectRatio/String');aspectratio(rfr.'DisplayAspectRatio/String');framerate(rfr.'FrameRate');'default'(rfr.'Default' == "Yes" ? "True" : "False");forced(rfr.'Forced' == "Yes" ? "True" : "False");duration(rfr.'Duration' ? (int) Math.floor(vu / 60000) : 0);durationinseconds(rfr.'Duration' ? (int) Math.floor(vu / 1000) : 0)}};target.mediaInfo.Audio.each { Kj ->  audio {codec(Kj.'Format');micodec(Kj.'Format');language(Kj.'Language/String3');channels(Kj.'Channel(s)');samplingrate(Kj.'SamplingRate');'default'(Kj.'Default' == "Yes" ? "True" : "False");forced(Kj.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { mP ->  subtitle {codec(mP.'Format');micodec(mP.'Format');width('0');height('0');language(mP.'Language/String3');'default'(mP.'Default' == "Yes" ? "True" : "False");forced(mP.'Forced' == "Yes" ? "True" : "False")}}}}}}}