{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def teJ = target.dir;def OW = any{ s } { 0 };def xKK = any{ e } { special };def LW = 0;def Pj = null;try {if (db.TheTVDB?.id) {def Ty = "https://api.tvmaze.com";def SWV = curl "$Ty/lookup/shows?thetvdb=${db.TheTVDB.id}";def uF = SWV.id;Pj = curl "$Ty/shows/$uF/episodebynumber?season=$OW&number=$xKK";LW = Pj.id}} catch (Exception err) {};def xs = "";def mc = "en-US";def yP = null;def JFT = new File("$home/.filebotsecrets.json");if (JFT.exists()) {def rjm = new groovy.json.JsonSlurper().parseText(JFT.text);xs = rjm.xs;mc = rjm.language;yP = rjm.person_info_dir};def ZyF = "https://api.themoviedb.org/3/tv/$id/season/$OW/episode/$xKK";def ruN = ["accept": "application/json"];def CIQ = curl(ruN, "$ZyF?language=$mc&api_key=$xs");def f_ = curl(ruN, "$ZyF/external_ids?api_key=$xs");def DQE = curl(ruN, "$ZyF/credits?language=$mc&api_key=$xs");def gfC = curl(ruN, "$ZyF/images?include_image_language=en%2Cnull&api_key=$xs");def eCO = (teJ / target.nameWithoutExtension + "-thumb.jpg").toString();def xMI = new File(eCO);def Bw = new File(eCO.replace("-thumb",""));if (!(xMI.exists() || Bw.exists()) && gfC.stills.size() > 0) {def beL = "https://image.tmdb.org/t/p/original${gfC.stills[0].file_path}";system "curl", "-o", teJ / target.nameWithoutExtension + "-thumb.jpg", beL};def dW = [];(DQE.cast + DQE.guest_stars).eachWithIndex { pQZ, VH ->  def EfL = "$yP/${pQZ.name[0]}/${pQZ.name}";def Ko = pQZ.order ?: VH + dW.size();dW << [Pw: pQZ.name, EfT: pQZ.character, Yvv: Ko, EfL: "${EfL}/folder.jpg"];if (yP) {def ip = new File(EfL);if (!ip.exists()) {ip.mkdirs();system "curl", "-o", "${EfL}/folder.jpg", "https://image.tmdb.org/t/p/original${pQZ.profile_path}"}}};def nEz = teJ / target.nameWithoutExtension + ".nfo";XML(nEz) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(CIQ.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (f_?.imdb_id) {uniqueid(type: "imdb", value: f_.imdb_id, f_.imdb_id);imdbid(f_.imdb_id)};if (f_?.tvdb_id) {uniqueid(type: "tvdb", value: f_.tvdb_id, f_.tvdb_id);tvdbid(f_.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (LW) {uniqueid(type: "tvmaze", value: LW, LW);tvmazeid(LW)}} catch (Exception err) {};if (xMI.exists()) {art {poster(eCO)}};dW.each { tXo ->  actor {name(tXo.Pw);role(tXo.EfT);sortorder(tXo.Yvv);if (yP) { thumb(tXo.EfL) }}};showtitle(n);episode(xKK);season(OW);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { DvX ->  video {def XJU = Float.parseFloat(DvX.'Duration');codec(DvX.'Format');micodec(DvX.'Format');bitrate(DvX.'BitRate');width(DvX.'Width');height(DvX.'Height');aspect(DvX.'DisplayAspectRatio/String');aspectratio(DvX.'DisplayAspectRatio/String');framerate(DvX.'FrameRate');'default'(DvX.'Default' == "Yes" ? "True" : "False");forced(DvX.'Forced' == "Yes" ? "True" : "False");duration(DvX.'Duration' ? (int) Math.floor(XJU / 60000) : 0);durationinseconds(DvX.'Duration' ? (int) Math.floor(XJU / 1000) : 0)}};target.mediaInfo.Audio.each { yPG ->  audio {codec(yPG.'Format');micodec(yPG.'Format');language(yPG.'Language/String3');channels(yPG.'Channel(s)');samplingrate(yPG.'SamplingRate');'default'(yPG.'Default' == "Yes" ? "True" : "False");forced(yPG.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { IE ->  subtitle {codec(IE.'Format');micodec(IE.'Format');width('0');height('0');language(IE.'Language/String3');'default'(IE.'Default' == "Yes" ? "True" : "False");forced(IE.'Forced' == "Yes" ? "True" : "False")}}}}}}}