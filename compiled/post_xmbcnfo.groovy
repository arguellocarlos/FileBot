{ source, target, metadata -> if (type.toString() != "Episode" || !vf || ext =~ /(ass|srt|ssa|vtt)/) {return null};def Otb = target.dir;def yHl = any{ s } { 0 };def vrh = any{ e } { special };def HIR = 0;def mVb = null;try {if (db.TheTVDB?.id) {def xjy = "https://api.tvmaze.com";def Vd = curl "$xjy/lookup/shows?thetvdb=${db.TheTVDB.id}";def _vm = Vd.id;mVb = curl "$xjy/shows/$_vm/episodebynumber?season=$yHl&number=$vrh";HIR = mVb.id}} catch (Exception err) {};def lYu = "";def fr = "en-US";def ifD = null;def GaD = new File("$home/.filebotsecrets.json");if (GaD.exists()) {def GEw = new groovy.json.JsonSlurper().parseText(GaD.text);lYu = GEw.lYu;fr = GEw.language;ifD = GEw.person_info_dir};def UjD = "https://api.themoviedb.org/3/tv/$id/season/$yHl/episode/$vrh";def td = ["accept": "application/json"];def TTk = curl(td, "$UjD?language=$fr&api_key=$lYu");def GjA = curl(td, "$UjD/external_ids?api_key=$lYu");def cI = curl(td, "$UjD/credits?language=$fr&api_key=$lYu");def Xja = curl(td, "$UjD/images?include_image_language=en%2Cnull&api_key=$lYu");def LTV = (Otb / target.nameWithoutExtension + "-thumb.jpg").toString();def AU = new File(LTV);def WQ = new File(LTV.replace("-thumb",""));if (!(AU.exists() || WQ.exists()) && Xja.stills.size() > 0) {def RXv = "https://image.tmdb.org/t/p/original${Xja.stills[0].file_path}";system "curl", "-o", Otb / target.nameWithoutExtension + "-thumb.jpg", RXv};def HUl = [];(cI.cast + cI.guest_stars).eachWithIndex { aa, oek -> def Ndl = "$ifD/${aa.name[0]}/${aa.name}";def rkk = aa.order ?: oek + HUl.size();HUl << [FI: aa.name, Yx: aa.character, OJ: rkk, Ndl: "${Ndl}/folder.jpg"];if (ifD) {def hIg = new File(Ndl);if (!hIg.exists()) {hIg.mkdirs();system "curl", "-o", "${Ndl}/folder.jpg", "https://image.tmdb.org/t/p/original${aa.profile_path}"}}};def ihW = Otb / target.nameWithoutExtension + ".nfo";XML(ihW) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(TTk.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (GjA?.imdb_id) {uniqueid(type: "imdb", value: GjA.imdb_id, GjA.imdb_id);imdbid(GjA.imdb_id)};if (GjA?.tvdb_id) {uniqueid(type: "tvdb", value: GjA.tvdb_id, GjA.tvdb_id);tvdbid(GjA.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (HIR) {uniqueid(type: "tvmaze", value: HIR, HIR);tvmazeid(HIR)}} catch (Exception err) {};if (AU.exists()) {art {poster(LTV)}};HUl.each { qd ->  actor {name(qd.FI);role(qd.Yx);sortorder(qd.OJ);if (ifD) { thumb(qd.Ndl) }}};showtitle(n);episode(vrh);season(yHl);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { Zp ->  video {def rnc = Float.parseFloat(Zp.'Duration');codec(Zp.'Format');micodec(Zp.'Format');bitrate(Zp.'BitRate');width(Zp.'Width');height(Zp.'Height');aspect(Zp.'DisplayAspectRatio/String');aspectratio(Zp.'DisplayAspectRatio/String');framerate(Zp.'FrameRate');'default'(Zp.'Default' == "Yes" ? "True" : "False");forced(Zp.'Forced' == "Yes" ? "True" : "False");duration(Zp.'Duration' ? (int) Math.floor(rnc / 60000) : 0);durationinseconds(Zp.'Duration' ? (int) Math.floor(rnc / 1000) : 0)}};target.mediaInfo.Audio.each { pdt ->  audio {codec(pdt.'Format');micodec(pdt.'Format');language(pdt.'Language/String3');channels(pdt.'Channel(s)');samplingrate(pdt.'SamplingRate');'default'(pdt.'Default' == "Yes" ? "True" : "False");forced(pdt.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { rmU ->  subtitle {codec(rmU.'Format');micodec(rmU.'Format');width('0');height('0');language(rmU.'Language/String3');'default'(rmU.'Default' == "Yes" ? "True" : "False");forced(rmU.'Forced' == "Yes" ? "True" : "False")}}}}}}}