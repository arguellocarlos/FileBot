{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def baV = target.dir;def LP = any{ s } { 0 };def JeH = any{ e } { special };def cx = 0;def Er = null;try {if (db.TheTVDB?.id) {def HHY = "https://api.tvmaze.com";def bzD = curl "$HHY/lookup/shows?thetvdb=${db.TheTVDB.id}";def uWH = bzD.id;Er = curl "$HHY/shows/$uWH/episodebynumber?season=$LP&number=$JeH";cx = Er.id}} catch (Exception err) {};def jd = "";def DCh = "en-US";def nR = null;def pyl = new File("$home/.filebotsecrets.json");if (pyl.exists()) {def YU = new groovy.json.JsonSlurper().parseText(pyl.text);jd = YU.jd;DCh = YU.language;nR = YU.person_info_dir};def _mS = "https://api.themoviedb.org/3/tv/$id/season/$LP/episode/$JeH";def bC = ["accept": "application/json"];def _Sa = curl(bC, "$_mS?language=$DCh&api_key=$jd");def Cy = curl(bC, "$_mS/external_ids?api_key=$jd");def EdL = curl(bC, "$_mS/credits?language=$DCh&api_key=$jd");def LEM = curl(bC, "$_mS/images?include_image_language=en%2Cnull&api_key=$jd");def Otx = (baV / target.nameWithoutExtension + "-thumb.jpg").toString();def Gz = new File(Otx);def fB = new File(Otx.replace("-thumb",""));if (!(Gz.exists() || fB.exists()) && LEM.stills.size() > 0) {def oCT = "https://image.tmdb.org/t/p/original${LEM.stills[0].file_path}";system "curl", "-o", baV / target.nameWithoutExtension + "-thumb.jpg", oCT};def RF = [];(EdL.cast + EdL.guest_stars).eachWithIndex { cnV, up ->  def yt = "$nR/${cnV.name[0]}/${cnV.name}";def UY = cnV.order ?: up + RF.size();RF << [xv: cnV.name, QgK: cnV.character, GMB: UY, yt: "${yt}/folder.jpg"];if (nR) {def rQ = new File(yt);if (!rQ.exists()) {rQ.mkdirs();system "curl", "-o", "${yt}/folder.jpg", "https://image.tmdb.org/t/p/original${cnV.profile_path}"}}};def ed = baV / target.nameWithoutExtension + ".nfo";XML(ed) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(_Sa.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (Cy?.imdb_id) {uniqueid(type: "imdb", value: Cy.imdb_id, Cy.imdb_id);imdbid(Cy.imdb_id)};if (Cy?.tvdb_id) {uniqueid(type: "tvdb", value: Cy.tvdb_id, Cy.tvdb_id);tvdbid(Cy.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (cx) {uniqueid(type: "tvmaze", value: cx, cx);tvmazeid(cx)}} catch (Exception err) {};if (Gz.exists()) {art {poster(Otx)}};RF.each { WmG ->  actor {name(WmG.xv);role(WmG.QgK);sortorder(WmG.GMB);if (nR) { thumb(WmG.yt) }}};showtitle(n);episode(JeH);season(LP);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { oW ->  video {def qT = Float.parseFloat(oW.'Duration');codec(oW.'Format');micodec(oW.'Format');bitrate(oW.'BitRate');width(oW.'Width');height(oW.'Height');aspect(oW.'DisplayAspectRatio/String');aspectratio(oW.'DisplayAspectRatio/String');framerate(oW.'FrameRate');'default'(oW.'Default' == "Yes" ? "True" : "False");forced(oW.'Forced' == "Yes" ? "True" : "False");duration(oW.'Duration' ? (int) Math.floor(qT / 60000) : 0);durationinseconds(oW.'Duration' ? (int) Math.floor(qT / 1000) : 0)}};target.mediaInfo.Audio.each { mX ->  audio {codec(mX.'Format');micodec(mX.'Format');language(mX.'Language/String3');channels(mX.'Channel(s)');samplingrate(mX.'SamplingRate');'default'(mX.'Default' == "Yes" ? "True" : "False");forced(mX.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { qER ->  subtitle {codec(qER.'Format');micodec(qER.'Format');width('0');height('0');language(qER.'Language/String3');'default'(qER.'Default' == "Yes" ? "True" : "False");forced(qER.'Forced' == "Yes" ? "True" : "False")}}}}}}}