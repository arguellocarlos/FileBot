{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def OyN = target.dir;def CQY = any{ s } { 0 };def cC = any{ e } { special };def lqr = 0;def oMg = null;try {if (db.TheTVDB?.id) {def tG = "https://api.tvmaze.com";def xT = curl "$tG/lookup/shows?thetvdb=${db.TheTVDB.id}";def la = xT.id;oMg = curl "$tG/shows/$la/episodebynumber?season=$CQY&number=$cC";lqr = oMg.id}} catch (Exception err) {};def LRU = "";def eX = "en-US";def yD = null;def nqw = new File("$home/.filebotsecrets.json");if (nqw.exists()) {def FyR = new groovy.json.JsonSlurper().parseText(nqw.text);LRU = FyR.LRU;eX = FyR.language;yD = FyR.person_info_dir};def Uub = "https://api.themoviedb.org/3/tv/$id/season/$CQY/episode/$cC";def rf = ["accept": "application/json"];def jIC = curl(rf, "$Uub?language=$eX&api_key=$LRU");def zp = curl(rf, "$Uub/external_ids?api_key=$LRU");def mBg = curl(rf, "$Uub/credits?language=$eX&api_key=$LRU");def hK = curl(rf, "$Uub/images?include_image_language=en%2Cnull&api_key=$LRU");def wdg = (OyN / target.nameWithoutExtension + "-thumb.jpg").toString();def gkB = new File(wdg);def nh = new File(wdg.replace("-thumb",""));if (!(gkB.exists() || nh.exists()) && hK.stills.size() > 0) {def qB = "https://image.tmdb.org/t/p/original${hK.stills[0].file_path}";system "curl", "-o", OyN / target.nameWithoutExtension + "-thumb.jpg", qB};def Jhz = [];(mBg.cast + mBg.guest_stars).eachWithIndex { FF, mGZ ->  def Q_M = "$yD/${FF.name[0]}/${FF.name}";def UXM = FF.order ?: mGZ + Jhz.size();Jhz << [TWH: FF.name, GrY: FF.character, zHK: UXM, Q_M: "${Q_M}/folder.jpg"];if (yD) {def cVN = new File(Q_M);if (!cVN.exists()) {cVN.mkdirs();system "curl", "-o", "${Q_M}/folder.jpg", "https://image.tmdb.org/t/p/original${FF.profile_path}"}}};def UAH = OyN / target.nameWithoutExtension + ".nfo";XML(UAH) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(jIC.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (zp?.imdb_id) {uniqueid(type: "imdb", value: zp.imdb_id, zp.imdb_id);imdbid(zp.imdb_id)};if (zp?.tvdb_id) {uniqueid(type: "tvdb", value: zp.tvdb_id, zp.tvdb_id);tvdbid(zp.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (lqr) {uniqueid(type: "tvmaze", value: lqr, lqr);tvmazeid(lqr)}} catch (Exception err) {};if (gkB.exists()) {art {poster(wdg)}};Jhz.each { ZW ->  actor {name(ZW.TWH);role(ZW.GrY);sortorder(ZW.zHK);if (yD) { thumb(ZW.Q_M) }}};showtitle(n);episode(cC);season(CQY);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { sn ->  video {def FIk = Float.parseFloat(sn.'Duration');codec(sn.'Format');micodec(sn.'Format');bitrate(sn.'BitRate');width(sn.'Width');height(sn.'Height');aspect(sn.'DisplayAspectRatio/String');aspectratio(sn.'DisplayAspectRatio/String');framerate(sn.'FrameRate');'default'(sn.'Default' == "Yes" ? "True" : "False");forced(sn.'Forced' == "Yes" ? "True" : "False");duration(sn.'Duration' ? (int) Math.floor(FIk / 60000) : 0);durationinseconds(sn.'Duration' ? (int) Math.floor(FIk / 1000) : 0)}};target.mediaInfo.Audio.each { Tjv ->  audio {codec(Tjv.'Format');micodec(Tjv.'Format');language(Tjv.'Language/String3');channels(Tjv.'Channel(s)');samplingrate(Tjv.'SamplingRate');'default'(Tjv.'Default' == "Yes" ? "True" : "False");forced(Tjv.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { nkP ->  subtitle {codec(nkP.'Format');micodec(nkP.'Format');width('0');height('0');language(nkP.'Language/String3');'default'(nkP.'Default' == "Yes" ? "True" : "False");forced(nkP.'Forced' == "Yes" ? "True" : "False")}}}}}}}