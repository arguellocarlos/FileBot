{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def jI = target.dir;def Zs = any{ s } { 0 };def rg = any{ e } { special };def FZa = 0;def Xb = null;try {if (db.TheTVDB?.id) {def ffK = "https://api.tvmaze.com";def xe = curl "$ffK/lookup/shows?thetvdb=${db.TheTVDB.id}";def at = xe.id;Xb = curl "$ffK/shows/$at/episodebynumber?season=$Zs&number=$rg";FZa = Xb.id}} catch (Exception err) {};def mwF = "";def ECB = "en-US";def pJ = null;def tyy = new File("$home/.filebotsecrets.json");if (tyy.exists()) {def _PJ = new groovy.json.JsonSlurper().parseText(tyy.text);mwF = _PJ.mwF;ECB = _PJ.language;pJ = _PJ.person_info_dir};def aK = "https://api.themoviedb.org/3/tv/$id/season/$Zs/episode/$rg";def Ds = ["accept": "application/json"];def r_i = curl(Ds, "$aK?language=$ECB&api_key=$mwF");def NV = curl(Ds, "$aK/external_ids?api_key=$mwF");def IM = curl(Ds, "$aK/credits?language=$ECB&api_key=$mwF");def GCK = curl(Ds, "$aK/images?include_image_language=en%2Cnull&api_key=$mwF");def kuL = (jI / target.nameWithoutExtension + "-thumb.jpg").toString();def AB = new File(kuL);def NTz = new File(kuL.replace("-thumb",""));if (!(AB.exists() || NTz.exists()) && GCK.stills.size() > 0) {def PU = "https://image.tmdb.org/t/p/original${GCK.stills[0].file_path}";system "curl", "-o", jI / target.nameWithoutExtension + "-thumb.jpg", PU};def uYr = [];(IM.cast + IM.guest_stars).eachWithIndex { DAI, tk ->  def au = "$pJ/${DAI.name[0]}/${DAI.name}";def tGn = DAI.order ?: tk + uYr.size();uYr << [vC: DAI.name, oly: DAI.character, beG: tGn, au: "${au}/folder.jpg"];if (pJ) {def XZ = new File(au);if (!XZ.exists()) {XZ.mkdirs();system "curl", "-o", "${au}/folder.jpg", "https://image.tmdb.org/t/p/original${DAI.profile_path}"}}};def Ob_ = jI / target.nameWithoutExtension + ".nfo";XML(Ob_) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(r_i.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (NV?.imdb_id) {uniqueid(type: "imdb", value: NV.imdb_id, NV.imdb_id);imdbid(NV.imdb_id)};if (NV?.tvdb_id) {uniqueid(type: "tvdb", value: NV.tvdb_id, NV.tvdb_id);tvdbid(NV.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (FZa) {uniqueid(type: "tvmaze", value: FZa, FZa);tvmazeid(FZa)}} catch (Exception err) {};if (AB.exists()) {art {poster(kuL)}};uYr.each { JQw ->  actor {name(JQw.vC);role(JQw.oly);sortorder(JQw.beG);if (pJ) { thumb(JQw.au) }}};showtitle(n);episode(rg);season(Zs);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { XXO ->  video {def oz = Float.parseFloat(XXO.'Duration');codec(XXO.'Format');micodec(XXO.'Format');bitrate(XXO.'BitRate');width(XXO.'Width');height(XXO.'Height');aspect(XXO.'DisplayAspectRatio/String');aspectratio(XXO.'DisplayAspectRatio/String');framerate(XXO.'FrameRate');'default'(XXO.'Default' == "Yes" ? "True" : "False");forced(XXO.'Forced' == "Yes" ? "True" : "False");duration(XXO.'Duration' ? (int) Math.floor(oz / 60000) : 0);durationinseconds(XXO.'Duration' ? (int) Math.floor(oz / 1000) : 0)}};target.mediaInfo.Audio.each { rBm ->  audio {codec(rBm.'Format');micodec(rBm.'Format');language(rBm.'Language/String3');channels(rBm.'Channel(s)');samplingrate(rBm.'SamplingRate');'default'(rBm.'Default' == "Yes" ? "True" : "False");forced(rBm.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { tKg ->  subtitle {codec(tKg.'Format');micodec(tKg.'Format');width('0');height('0');language(tKg.'Language/String3');'default'(tKg.'Default' == "Yes" ? "True" : "False");forced(tKg.'Forced' == "Yes" ? "True" : "False")}}}}}}}