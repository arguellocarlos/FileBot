{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def _L = target.dir;def fF = any{ s } { 0 };def zFK = any{ e } { special };def jo = 0;def iX = null;try {if (db.TheTVDB?.id) {def hC = "https://api.tvmaze.com";def VLt = curl "$hC/lookup/shows?thetvdb=${db.TheTVDB.id}";def KY = VLt.id;iX = curl "$hC/shows/$KY/episodebynumber?season=$fF&number=$zFK";jo = iX.id}} catch (Exception err) {};def qgH = "";def gYM = "en-US";def Hz = null;def CZ = new File("$home/.filebotsecrets.json");if (CZ.exists()) {def rv = new groovy.json.JsonSlurper().parseText(CZ.text);qgH = rv.qgH;gYM = rv.language;Hz = rv.person_info_dir};def _r = "https://api.themoviedb.org/3/tv/$id/season/$fF/episode/$zFK";def xNV = ["accept": "application/json"];def Ss = curl(xNV, "$_r?language=$gYM&api_key=$qgH");def OaS = curl(xNV, "$_r/external_ids?api_key=$qgH");def Xq = curl(xNV, "$_r/credits?language=$gYM&api_key=$qgH");def CoI = curl(xNV, "$_r/images?include_image_language=en%2Cnull&api_key=$qgH");def W_ = (_L / target.nameWithoutExtension + "-thumb.jpg").toString();def tW = new File(W_);def Iac = new File(W_.replace("-thumb",""));if (!(tW.exists() || Iac.exists()) && CoI.stills.size() > 0) {def Wgy = "https://image.tmdb.org/t/p/original${CoI.stills[0].file_path}";system "curl", "-o", _L / target.nameWithoutExtension + "-thumb.jpg", Wgy};def CW = [];(Xq.cast + Xq.guest_stars).eachWithIndex { UCU, eW ->  def Py = "$Hz/${UCU.name[0]}/${UCU.name}";def vnA = UCU.order ?: eW + CW.size();CW << [KrC: UCU.name, tTf: UCU.character, iAS: vnA, Py: "${Py}/folder.jpg"];if (Hz) {def pwJ = new File(Py);if (!pwJ.exists()) {pwJ.mkdirs();system "curl", "-o", "${Py}/folder.jpg", "https://image.tmdb.org/t/p/original${UCU.profile_path}"}}};def tm = _L / target.nameWithoutExtension + ".nfo";XML(tm) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(Ss.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (OaS?.imdb_id) {uniqueid(type: "imdb", value: OaS.imdb_id, OaS.imdb_id);imdbid(OaS.imdb_id)};if (OaS?.tvdb_id) {uniqueid(type: "tvdb", value: OaS.tvdb_id, OaS.tvdb_id);tvdbid(OaS.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (jo) {uniqueid(type: "tvmaze", value: jo, jo);tvmazeid(jo)}} catch (Exception err) {};if (tW.exists()) {art {poster(W_)}};CW.each { oL ->  actor {name(oL.KrC);role(oL.tTf);sortorder(oL.iAS);if (Hz) { thumb(oL.Py) }}};showtitle(n);episode(zFK);season(fF);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { IQp ->  video {def yT = Float.parseFloat(IQp.'Duration');codec(IQp.'Format');micodec(IQp.'Format');bitrate(IQp.'BitRate');width(IQp.'Width');height(IQp.'Height');aspect(IQp.'DisplayAspectRatio/String');aspectratio(IQp.'DisplayAspectRatio/String');framerate(IQp.'FrameRate');'default'(IQp.'Default' == "Yes" ? "True" : "False");forced(IQp.'Forced' == "Yes" ? "True" : "False");duration(IQp.'Duration' ? (int) Math.floor(yT / 60000) : 0);durationinseconds(IQp.'Duration' ? (int) Math.floor(yT / 1000) : 0)}};target.mediaInfo.Audio.each { rxl ->  audio {codec(rxl.'Format');micodec(rxl.'Format');language(rxl.'Language/String3');channels(rxl.'Channel(s)');samplingrate(rxl.'SamplingRate');'default'(rxl.'Default' == "Yes" ? "True" : "False");forced(rxl.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { wyp ->  subtitle {codec(wyp.'Format');micodec(wyp.'Format');width('0');height('0');language(wyp.'Language/String3');'default'(wyp.'Default' == "Yes" ? "True" : "False");forced(wyp.'Forced' == "Yes" ? "True" : "False")}}}}}}}