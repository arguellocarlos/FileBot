{ source, target, metadata ->  if (type.toString() != "Episode" || !vf || f.subtitle || f.audio || f.image) {return null};def Uyn = target.dir;def Zuw = any{ s } { 0 };def nAN = any{ e } { special };def WE = 0;def qb = null;try {if (db.TheTVDB?.id) {def mg = "https://api.tvmaze.com";def Fm = curl "$mg/lookup/shows?thetvdb=${db.TheTVDB.id}";def _Xl = Fm.id;qb = curl "$mg/shows/$_Xl/episodebynumber?season=$Zuw&number=$nAN";WE = qb.id}} catch (Exception err) {};def szH = "";def wk = "en-US";def pd = null;def DJg = new File("$home/.filebotsecrets.json");if (DJg.exists()) {def yp = new groovy.json.JsonSlurper().parseText(DJg.text);szH = yp.szH;wk = yp.language;pd = yp.person_info_dir};def Ms = "https://api.themoviedb.org/3/tv/$id/season/$Zuw/episode/$nAN";def jx = ["accept": "application/json"];def QXx = curl(jx, "$Ms?language=$wk&api_key=$szH");def XH = curl(jx, "$Ms/external_ids?api_key=$szH");def aR = curl(jx, "$Ms/credits?language=$wk&api_key=$szH");def tpi = curl(jx, "$Ms/images?include_image_language=en%2Cnull&api_key=$szH");def qW = (Uyn / target.nameWithoutExtension + "-thumb.jpg").toString();def Soc = new File(qW);def ixs = new File(qW.replace("-thumb",""));if (!(Soc.exists() || ixs.exists()) && tpi.stills.size() > 0) {def xK = "https://image.tmdb.org/t/p/original${tpi.stills[0].file_path}";system "curl", "-o", Uyn / target.nameWithoutExtension + "-thumb.jpg", xK};def bdM = [];(aR.cast + aR.guest_stars).eachWithIndex { Js, KPm ->  def rRM = "$pd/${Js.name[0]}/${Js.name}";def IP = Js.order ?: KPm + bdM.size();bdM << [hyM: Js.name, dos: Js.character, BO_: IP, rRM: "${rRM}/folder.jpg"];if (pd) {def bDu = new File(rRM);if (!bDu.exists()) {bDu.mkdirs();system "curl", "-o", "${rRM}/folder.jpg", "https://image.tmdb.org/t/p/original${Js.profile_path}"}}};def oVG = Uyn / target.nameWithoutExtension + ".nfo";XML(oVG) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(QXx.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (XH?.imdb_id) {uniqueid(type: "imdb", value: XH.imdb_id, XH.imdb_id);imdbid(XH.imdb_id)};if (XH?.tvdb_id) {uniqueid(type: "tvdb", value: XH.tvdb_id, XH.tvdb_id);tvdbid(XH.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (WE) {uniqueid(type: "tvmaze", value: WE, WE);tvmazeid(WE)}} catch (Exception err) {};if (Soc.exists()) {art {poster(qW)}};bdM.each { XKU ->  actor {name(XKU.hyM);role(XKU.dos);sortorder(XKU.BO_);if (pd) { thumb(XKU.rRM) }}};showtitle(n);episode(nAN);season(Zuw);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { Ms ->  video {def sYf = Float.parseFloat(Ms.'Duration');codec(Ms.'Format');micodec(Ms.'Format');bitrate(Ms.'BitRate');width(Ms.'Width');height(Ms.'Height');aspect(Ms.'DisplayAspectRatio/String');aspectratio(Ms.'DisplayAspectRatio/String');framerate(Ms.'FrameRate');'default'(Ms.'Default' == "Yes" ? "True" : "False");forced(Ms.'Forced' == "Yes" ? "True" : "False");duration(Ms.'Duration' ? (int) Math.floor(sYf / 60000) : 0);durationinseconds(Ms.'Duration' ? (int) Math.floor(sYf / 1000) : 0)}};target.mediaInfo.Audio.each { lPq ->  audio {codec(lPq.'Format');micodec(lPq.'Format');language(lPq.'Language/String3');channels(lPq.'Channel(s)');samplingrate(lPq.'SamplingRate');'default'(lPq.'Default' == "Yes" ? "True" : "False");forced(lPq.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { dGX ->  subtitle {codec(dGX.'Format');micodec(dGX.'Format');width('0');height('0');language(dGX.'Language/String3');'default'(dGX.'Default' == "Yes" ? "True" : "False");forced(dGX.'Forced' == "Yes" ? "True" : "False")}}}}}}}