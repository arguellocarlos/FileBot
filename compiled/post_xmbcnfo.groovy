{ source, target, metadata -> if (type.toString() != "Episode" || !vf || ext =~ /(ass|srt|ssa|vtt)/) {return null};def TZc = target.dir;def dJ = any{ s } { 0 };def kCo = any{ e } { special };def cxk = 0;def CU = null;try {if (db.TheTVDB?.id) {def pt = "https://api.tvmaze.com";def luI = curl "$pt/lookup/shows?thetvdb=${db.TheTVDB.id}";def KxR = luI.id;CU = curl "$pt/shows/$KxR/episodebynumber?season=$dJ&number=$kCo";cxk = CU.id}} catch (Exception err) {};def sw = "";def tno = "en-US";def cX = null;def MG = new File("$home/.filebotsecrets.json");if (MG.exists()) {def qZY = new groovy.json.JsonSlurper().parseText(MG.text);sw = qZY.sw;tno = qZY.language;cX = qZY.person_info_dir};def CJE = "https://api.themoviedb.org/3/tv/$id/season/$dJ/episode/$kCo";def aa = ["accept": "application/json"];def ZWz = curl(aa, "$CJE?language=$tno&api_key=$sw");def gra = curl(aa, "$CJE/external_ids?api_key=$sw");def _qM = curl(aa, "$CJE/credits?language=$tno&api_key=$sw");def dPg = curl(aa, "$CJE/images?include_image_language=en%2Cnull&api_key=$sw");def KL = (TZc / target.nameWithoutExtension + "-thumb.jpg").toString();def pAo = new File(KL);def PDj = new File(KL.replace("-thumb",""));if (!(pAo.exists() || PDj.exists()) && dPg.stills.size() > 0) {def vur = "https://image.tmdb.org/t/p/original${dPg.stills[0].file_path}";system "curl", "-o", TZc / target.nameWithoutExtension + "-thumb.jpg", vur};def wh = [];(_qM.cast + _qM.guest_stars).eachWithIndex { Xc, K_C -> def Zx = "$cX/${Xc.name[0]}/${Xc.name}";def RZ = Xc.order ?: K_C + wh.size();wh << [YCB: Xc.name, tt: Xc.character, Zn: RZ, Zx: "${Zx}/folder.jpg"];if (cX) {def DD_ = new File(Zx);if (!DD_.exists()) {DD_.mkdirs();system "curl", "-o", "${Zx}/folder.jpg", "https://image.tmdb.org/t/p/original${Xc.profile_path}"}}};def vw = TZc / target.nameWithoutExtension + ".nfo";XML(vw) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(ZWz.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (gra?.imdb_id) {uniqueid(type: "imdb", value: gra.imdb_id, gra.imdb_id);imdbid(gra.imdb_id)};if (gra?.tvdb_id) {uniqueid(type: "tvdb", value: gra.tvdb_id, gra.tvdb_id);tvdbid(gra.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (cxk) {uniqueid(type: "tvmaze", value: cxk, cxk);tvmazeid(cxk)}} catch (Exception err) {};if (pAo.exists()) {art {poster(KL)}};wh.each { sP ->  actor {name(sP.YCB);role(sP.tt);sortorder(sP.Zn);if (cX) { thumb(sP.Zx) }}};showtitle(n);episode(kCo);season(dJ);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { ku_ ->  video {def xy = Float.parseFloat(ku_.'Duration');codec(ku_.'Format');micodec(ku_.'Format');bitrate(ku_.'BitRate');width(ku_.'Width');height(ku_.'Height');aspect(ku_.'DisplayAspectRatio/String');aspectratio(ku_.'DisplayAspectRatio/String');framerate(ku_.'FrameRate');'default'(ku_.'Default' == "Yes" ? "True" : "False");forced(ku_.'Forced' == "Yes" ? "True" : "False");duration(ku_.'Duration' ? (int) Math.floor(xy / 60000) : 0);durationinseconds(ku_.'Duration' ? (int) Math.floor(xy / 1000) : 0)}};target.mediaInfo.Audio.each { uVG ->  audio {codec(uVG.'Format');micodec(uVG.'Format');language(uVG.'Language/String3');channels(uVG.'Channel(s)');samplingrate(uVG.'SamplingRate');'default'(uVG.'Default' == "Yes" ? "True" : "False");forced(uVG.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { Nl ->  subtitle {codec(Nl.'Format');micodec(Nl.'Format');width('0');height('0');language(Nl.'Language/String3');'default'(Nl.'Default' == "Yes" ? "True" : "False");forced(Nl.'Forced' == "Yes" ? "True" : "False")}}}}}}}