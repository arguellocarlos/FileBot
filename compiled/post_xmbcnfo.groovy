{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def nC = target.dir;def ZdH = any{ s } { 0 };def Ia = any{ e } { special };def WDd = 0;def Ku = null;try {if (db.TheTVDB?.id) {def _at = "https://api.tvmaze.com";def jAx = curl "$_at/lookup/shows?thetvdb=${db.TheTVDB.id}";def zGB = jAx.id;Ku = curl "$_at/shows/$zGB/episodebynumber?season=$ZdH&number=$Ia";WDd = Ku.id}} catch (Exception err) {};def Zg = "";def IOD = "en-US";def wo = null;def uR = new File("$home/.filebotsecrets.json");if (uR.exists()) {def WV = new groovy.json.JsonSlurper().parseText(uR.text);Zg = WV.Zg;IOD = WV.language;wo = WV.person_info_dir};def srj = "https://api.themoviedb.org/3/tv/$id/season/$ZdH/episode/$Ia";def iH = ["accept": "application/json"];def IVi = curl(iH, "$srj?language=$IOD&api_key=$Zg");def Lv = curl(iH, "$srj/external_ids?api_key=$Zg");def lU = curl(iH, "$srj/credits?language=$IOD&api_key=$Zg");def xg = curl(iH, "$srj/images?include_image_language=en%2Cnull&api_key=$Zg");def Nx = (nC / target.nameWithoutExtension + "-thumb.jpg").toString();def ZVq = new File(Nx);def Dck = new File(Nx.replace("-thumb",""));if (!(ZVq.exists() || Dck.exists()) && xg.stills.size() > 0) {def oLx = "https://image.tmdb.org/t/p/original${xg.stills[0].file_path}";system "curl", "-o", nC / target.nameWithoutExtension + "-thumb.jpg", oLx};def ugA = [];(lU.cast + lU.guest_stars).eachWithIndex { XQ, izZ ->  def DDx = "$wo/${XQ.name[0]}/${XQ.name}";def pw = XQ.order ?: izZ + ugA.size();ugA << [QQJ: XQ.name, fEo: XQ.character, jXE: pw, DDx: "${DDx}/folder.jpg"];if (wo) {def Nr = new File(DDx);if (!Nr.exists()) {Nr.mkdirs();system "curl", "-o", "${DDx}/folder.jpg", "https://image.tmdb.org/t/p/original${XQ.profile_path}"}}};def qN = nC / target.nameWithoutExtension + ".nfo";XML(qN) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(IVi.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:XQ", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (Lv?.imdb_id) {uniqueid(type: "imdb", value: Lv.imdb_id, Lv.imdb_id);imdbid(Lv.imdb_id)};if (Lv?.tvdb_id) {uniqueid(type: "tvdb", value: Lv.tvdb_id, Lv.tvdb_id);tvdbid(Lv.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (WDd) {uniqueid(type: "tvmaze", value: WDd, WDd);tvmazeid(WDd)}} catch (Exception err) {};if (ZVq.exists()) {art {poster(Nx)}};ugA.each { Kx ->  actor {name(Kx.QQJ);role(Kx.fEo);sortorder(Kx.jXE);if (wo) { thumb(Kx.DDx) }}};showtitle(n);episode(Ia);season(ZdH);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { aq ->  video {def Dtf = Float.parseFloat(aq.'Duration');codec(aq.'Format');micodec(aq.'Format');bitrate(aq.'BitRate');width(aq.'Width');height(aq.'Height');aspect(aq.'DisplayAspectRatio/String');aspectratio(aq.'DisplayAspectRatio/String');framerate(aq.'FrameRate');'default'(aq.'Default' == "Yes" ? "True" : "False");forced(aq.'Forced' == "Yes" ? "True" : "False");duration(aq.'Duration' ? (int) Math.floor(Dtf / 60000) : 0);durationinseconds(aq.'Duration' ? (int) Math.floor(Dtf / 1000) : 0)}};target.mediaInfo.Audio.each { jt ->  audio {codec(jt.'Format');micodec(jt.'Format');language(jt.'Language/String3');channels(jt.'Channel(s)');samplingrate(jt.'SamplingRate');'default'(jt.'Default' == "Yes" ? "True" : "False");forced(jt.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { Hd ->  subtitle {codec(Hd.'Format');micodec(Hd.'Format');width('0');height('0');language(Hd.'Language/String3');'default'(Hd.'Default' == "Yes" ? "True" : "False");forced(Hd.'Forced' == "Yes" ? "True" : "False")}}}}}}}