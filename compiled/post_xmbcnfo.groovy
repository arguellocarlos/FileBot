{ source, target, metadata -> if (type.toString() != "Episode" || !vf || ext =~ /(ass|srt|ssa|vtt)/) {return null};def UkZ = target.dir;def cff = any{ s } { 0 };def nt = any{ e } { special };def WMN = 0;def cQ = null;try {if (db.TheTVDB?.id) {def Dy = "https://api.tvmaze.com";def cn = curl "$Dy/lookup/shows?thetvdb=${db.TheTVDB.id}";def yq = cn.id;cQ = curl "$Dy/shows/$yq/episodebynumber?season=$cff&number=$nt";WMN = cQ.id}} catch (Exception err) {};def Moh = "";def LX = "en-US";def TX = null;def kpg = new File("$home/.filebotsecrets.json");if (kpg.exists()) {def Evz = new groovy.json.JsonSlurper().parseText(kpg.text);Moh = Evz.Moh;LX = Evz.language;TX = Evz.person_info_dir};def Nd = "https://api.themoviedb.org/3/tv/$id/season/$cff/episode/$nt";def WS = ["accept": "application/json"];def ag = curl(WS, "$Nd?language=$LX&api_key=$Moh");def BTt = curl(WS, "$Nd/external_ids?api_key=$Moh");def UCL = curl(WS, "$Nd/credits?language=$LX&api_key=$Moh");def xyD = curl(WS, "$Nd/images?include_image_language=en%2Cnull&api_key=$Moh");def fo = (UkZ / target.nameWithoutExtension + "-thumb.jpg").toString();def gN = new File(fo);def ND_ = new File(fo.replace("-thumb",""));if (!(gN.exists() || ND_.exists()) && xyD.stills.size() > 0) {def tcX = "https://image.tmdb.org/t/p/original${xyD.stills[0].file_path}";system "curl", "-o", UkZ / target.nameWithoutExtension + "-thumb.jpg", tcX};def lCj = [];(UCL.cast + UCL.guest_stars).eachWithIndex { xs, XSV -> def oxb = "$TX/${xs.name[0]}/${xs.name}";def JEp = xs.order ?: XSV + lCj.size();lCj << [ez: xs.name, BI: xs.character, Dha: JEp, oxb: "${oxb}/folder.jpg"];if (TX) {def ed = new File(oxb);if (!ed.exists()) {ed.mkdirs();system "curl", "-o", "${oxb}/folder.jpg", "https://image.tmdb.org/t/p/original${xs.profile_path}"}}};def nN = UkZ / target.nameWithoutExtension + ".nfo";XML(nN) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(ag.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);year(airdate.format("yyyy"));uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (BTt?.imdb_id) {uniqueid(type: "imdb", value: BTt.imdb_id, BTt.imdb_id);imdbid(BTt.imdb_id)};if (BTt?.tvdb_id) {uniqueid(type: "tvdb", value: BTt.tvdb_id, BTt.tvdb_id);tvdbid(BTt.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (WMN) {uniqueid(type: "tvmaze", value: WMN, WMN);tvmazeid(WMN)}} catch (Exception err) {};if (gN.exists()) {art {poster(fo)}};lCj.each { al ->  actor {name(al.ez);role(al.BI);sortorder(al.Dha);if (TX) { thumb(al.oxb) }}};showtitle(n);episode(nt);season(cff);aired(airdate.format("yyyy-MM-dd"));fileinfo {streamdetails {target.mediaInfo.Video.each { bk ->  video {def RYF = Float.parseFloat(bk.'Duration');codec(bk.'Format');micodec(bk.'Format');bitrate(bk.'BitRate');width(bk.'Width');height(bk.'Height');aspect(bk.'DisplayAspectRatio/String');aspectratio(bk.'DisplayAspectRatio/String');framerate(bk.'FrameRate');'default'(bk.'Default' == "Yes" ? "True" : "False");forced(bk.'Forced' == "Yes" ? "True" : "False");duration(bk.'Duration' ? (int) Math.floor(RYF / 60000) : 0);durationinseconds(bk.'Duration' ? (int) Math.floor(RYF / 1000) : 0)}};target.mediaInfo.Audio.each { deM ->  audio {codec(deM.'Format');micodec(deM.'Format');language(deM.'Language/String3');channels(deM.'Channel(s)');samplingrate(deM.'SamplingRate');'default'(deM.'Default' == "Yes" ? "True" : "False");forced(deM.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { xQ ->  subtitle {codec(xQ.'Format');micodec(xQ.'Format');width('0');height('0');language(xQ.'Language/String3');'default'(xQ.'Default' == "Yes" ? "True" : "False");forced(xQ.'Forced' == "Yes" ? "True" : "False")}}}}}}}